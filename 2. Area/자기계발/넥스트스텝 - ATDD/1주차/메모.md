`260112`
- [도서 추천 - 린 애자일 기법을 활용한 테스트 주도 개발](https://www.yes24.com/product/goods/13161818)
- [1주차 미션](https://edu.nextstep.camp/s/1t00G7bI/ls/xEwpmMaZ)
- [코드 리뷰 절차](https://github.com/next-step/nextstep-docs/tree/master/codereview)

> [!info] 테스트는 살아 있는 문서이다. 
> 테스트가 없으면 나중에 설명할 때 복각(이해)하기 위해 많은 리소스가 들어간다
> 나를 믿는 대신에 테스트를 믿어 보도록 하자. 이는 곧 자신감으로 귀결 될 수 있다.

> [!info] 시나리오를 도출할 때는 육하원칙 (5W1H)를 사용한다

> [!info] 테스트 코드를 작성시 when을 먼저 작성한다. 그리고 then , given 순으로 작성한다

> AI를 활용하는 것은 좋으나, 기계적으로 작성된 (이해하지 x) 테스트 코드는 사용안하게 될 수 있다. 
- 철학에 대해 AI한테 질문하여 코드로 만들고 이를 이해하고, 의도가 맞는지 판단하도록 하자

**오후 8시 09분** 
- `인수 테스트로 개발을 주도하는 경험` 섹션 다시보기 
- `인수 테스트와 통합 테스트 비교` 섹션 다시보기


**Q.** 인수 테스트는 REST API에만 적용가능한가요? 배치 프로젝트에도 ATDD 적용 가능할까요?
**A.** 가능은 하다. 하지만 REST API가 상대적으로 난이도가 쉽다. 배치 같은 경우 외부 인프라 의존이 어려운데, Fake/Mock, 실제 서비스를 준비해야 한다. 결국 검증해야 할 조건과 `성공/실패`만 있다면 가능은 하다

테스트를 작성하기에는 일정이 바쁘고 구축하기 어렵다. 
- 테스트 작성하면 좋다는 건 다들 한다. 
- 구축 경험을 하는건 경험상 10%도 안되는거 같다.
- 남들이 하지 않는 무언가를 해보다보면 10%의 사람이 될 수도 있다. 

Q. 수료율은 어느 정도 되는가?
A. 마지막 주차까지 다하는 사람은 20~30% 정도이다. 다 안해도 수료증은 준다.

> AI 도구에서 서브 에이전트가 코드 분석을 담당한다.

> 우선 순위를 측정한다 > 인수 조건을 도출한다 > Gherkim 시나리오를 작성한다 
- Gherkim은 Cucumber에서 나온 문법인데, 형식상으로만 우선 따라해본다 
- 1주차에는 Cucumber를 사용하지 x 

> 마크다운 문서를 작성하실때 기술적인 것도 좋지만, 샘플 테스트 코드를 작성해두는 것이 효과적이다

**PR 요청시**
- 이번에 몰랐던 부분에 학습해보니 이렇다.  
- 그럼 이에 대한 피드백을 해준다 함
	- `PR을 작성할 때는 내가 리뷰 받고 싶은게 무엇인지 고민해보기`
> 최대한 PR 댓글을 활용할 수 있도록 한다. 코드 리뷰어는 강사 한분이 모두 한다 함

**1주차 단계별**
- 1단계의 경우 프롬프트를 사용하면 하루 안에 될거라 함
- 2단계의 경우 테스트 산출물까지 만듦
	- 개인별 역량 차이에 따라 여기서 시간 오래 걸릴 수 있다함 
	- 테스트 작성 경험이 많다면 충분이 하루에 2시간씩 했을때 통과 가능하다함
- 3단계에는 Production 코드를 건든다고 함
	- 이전 단계까지는 Production 코드를 건드는 일은 없다함

---

`260113`
- 강의 사이트에서 `[미션 시작하기]` 버튼을 누르면 저장소에 아이디명으로 브랜치가 생성된다 
- fork를 받는다 
- 내 저장소에 fork된 repository를 clone한다

```shell
git clone -b ljw1126 --single-branch git@github.com:ljw1126/atdd-camping-reservation.git

gco -b step1
```
- 작업이 완료 된 후 step1을 내 저장소에 올린다. 
- 그리고 [코드리뷰 2장](https://github.com/next-step/nextstep-docs/blob/master/codereview/review-step2.md)을 참고해 코드 리뷰 신청한다 


```shell
gco -b step1
git push origin step1
```
- step1 -> remote ljw1126 브랜치로 PR 생성 
- 강의 사이트에서 `[리뷰 요청]` 버튼 누르면 slack 알림 날라감

```shell
gco ljw1126

git remote add upstream https://github.com/next-step/atdd-camping-reservation.git

git fetch upstream ljw1126

// conflict 해결 

git checkout step2

// 만약 잘 안되면 
git checkout ljw1126
git reset --hard upstream/ljw1126
gco -b step2
```
- https://github.com/next-step/nextstep-docs/blob/master/codereview/review-step3.md

### controller 분석

#### HomeController
- 6개인데 .. html 페이지를 찾는듯하다. 이것도 필요한가 싶네??

#### ReservationController
(1)`POST http://localhost:8080/api/reservations`
- createReservation(.. )
- ReservationRequest를 받아 예약 생성하는거 같다.

(2) `GET http://localhost:8080/api/reservations/{{id}}`
- 예약을 단건 조회한다 
	- {{id}}

(3) `GET http://localhost:8080/api/reservations`
- 예약 목록을 조회한다. 
	- 날짜 기반 
	- 고객명 기반 
	- 아닌 경우 전체 조회

(4) `DELETE http://localhost:8080/api/reservations/{{id}}`
- 예약을 취소한다

(5) `PUT http://localhost:8080/api/reservations/{{id}}`
- 예약을 수정한다

(6) `GET http://localhost:8080/api/reservations/my`
- 나의 예약을 목록 조회한다. 
- name, phone 문자열 필요

(7) `GET http://localhost:8080/api/reservations/calendar`
- 예약 캘린더 조회



#### SiteController (캠핑 사이트 관리)
(1) `GET http://localhost:8080/api/sites`
- 전체 사이트 목록을 조회한다 

(2) `GET http://localhost:8080/api/sites/{{siteId}}`
- 사이트의 상세 정보를 조회한다

(3) `GET http://localhost:8080/api/sites/{{siteNumber}}/availability`
- 사이트 이용 가능 여부를 조회한다.

(4) `GET http://localhost:8080/api/sites/available`
- 이용 가능한 사이트 목록을 조회한다

(5) `GET http://localhost:8080/api/sites/search`
- 사이트를 검색한다 
	- 시작일, 종료일, 사이즈 파라미터 필요

---
> [!note] AI를 활용해서 만들고 난 후에 읽어본다. 다른 사람이 작성한 문서도 참고해보자

---
```
todo.md의 “1. 시스템 탐헝과 분석”을 수행하고 결과를 system-analysis.md 파일의 양식에 맞춰 기록해주세요. 현재 서버는 localhost:8080으로 실행중 입니다. 
```


첫번째 요청 결과
```
# 시스템 분석 결과

## API 목록
| Endpoint | Method | 목적 | 주요 파라미터 | 비고 |
|----------|--------|------|--------------|------|
| /api/sites | GET | 전체 캠핑장 사이트 목록 조회 | 없음 | 모든 사이트의 기본 정보(번호, 설명 등) 반환 |
| /api/sites/{siteId} | GET | 특정 사이트 상세 조회 | siteId (Path) | 사이트의 상세 정보 반환 |
| /api/sites/search | GET | 예약 가능한 사이트 검색 | startDate, endDate, size | **[버그]** 시작일과 종료일만 가용성 체크, 중간 날짜 무시함 |
| /api/reservations | POST | 예약 생성 | ReservationRequest Body (이름, 날짜, 사이트번호, 폰번호) | 30일 이내, 과거 날짜 불가, 이름 2자 이상 등 검증 |
| /api/reservations/{id} | GET | 예약 단건 조회 | id (Path) | 예약 상세 정보 반환 |
| /api/reservations | GET | 예약 목록 조회 | date (Optional), customerName (Optional) | 날짜별 또는 고객명별 예약 조회. 파라미터 없으면 전체 조회 |
| /api/reservations/my | GET | 내 예약 조회 | name, phone | 이름과 전화번호로 본인의 예약 목록 조회 |
| /api/reservations/calendar | GET | 월별 예약 캘린더 조회 | year, month, siteId | 특정 사이트의 월별 예약 상태(가능/불가능) 반환 |
| /api/reservations/{id} | PUT | 예약 수정 | id (Path), confirmationCode (Query), ReservationRequest Body | 본인 확인(코드) 후 예약 정보 수정 |
| /api/reservations/{id} | DELETE | 예약 취소 | id (Path), confirmationCode (Query) | 본인 확인(코드) 후 취소. 당일 취소 시 상태 구분됨 |

## 발견한 비즈니스 규칙

### 1. 예약 제한 및 검증
- **예약 기간**: 최대 30일까지만 예약 가능.
- **예약자 정보**: 이름은 2~20자, 전화번호는 숫자만 10~11자리 필수.
- **날짜 제한**: 과거 날짜 예약 불가, 종료일이 시작일보다 앞설 수 없음.

### 2. 가격 정책 (Hidden)
- **기본 요금**:
  - A구역 (대형): 80,000원
  - B구역 (소형): 50,000원
  - 기타: 60,000원
- **할증 (Surcharges)**:
  - 주말 (토, 일): 기본 요금의 30% 할증 (1.3배)
  - 성수기 (7월, 8월): 기본 요금의 50% 할증 (1.5배)
  - **성수기 주말**: 기본 요금의 70% 할증 (1.7배)

### 3. 포인트 적립 정책 (Inconsistent)
- 기본 적립률: 결제 금액의 5%
- 주말 포함 예약: 10% 적립 (`createReservation` 로직)
- *코드 불일치*: 별도 메서드(`calculatePoints`)에서는 성수기 예약 시 3% 적립 로직 존재하나 `createReservation`에는 반영 안 됨.
- *결제 수단별 차등*: (Deprecated 메서드 기준) 카드 10%, 모바일 8%, 계좌이체 5%, 현금 3%.

### 4. 사이트 데이터 및 설비
- **전기 사용**:
  - 코드 상 로직(`SiteService`): 사이트 번호가 'A'로 시작해야만 전기 사용 가능(`hasElectricity = true`).
  - 데이터 상 설명(`data.sql`): 'B' 구역 사이트 설명에도 "전기 있음"으로 명시됨. **(데이터와 로직 불일치)**

### 5. 예약 취소 정책
- 취소 시 환불 로직은 구현되어 있지 않고 상태만 변경됨.
- 당일 취소(`CANCELLED_SAME_DAY`)와 일반 취소(`CANCELLED`)로 상태가 구분됨.

### 6. 검색 로직의 치명적 허점
- 사이트 검색(`searchAvailableSites`) 시 **시작일과 종료일의 가용성만 확인**하고, 그 사이의 날짜들이 예약되어 있는지 확인하지 않음. 이로 인해 이미 예약된 날짜를 포함한 기간으로 중복 예약 검색이 될 가능성 있음.

```


```text
아래 내용을 참고해서 system-analysis.md을 수정해주세요
- 사이트와 예약 도메인 별로 API 엔드 포인트를 구분해주세요. 
- API 엔드 포인트가 총 12개인데, 누락된 API는 따로 구분해주세요.
- 명세서에 숨겨진 비즈니스 규칙을 표나 항목을 나눠 기록해주세요
- 버그 목록 (버그, 위치)을 찾아주세요
- 코드 이슈를 찾아주세요
```


```text
✦ system-analysis.md 파일을 요청하신 대로 수정 완료했습니다.
   1. API 분리: Reservation(7개)과 Site(5개) 도메인으로 나누어 총 12개의 API를 정리했습니다.
   2. 비즈니스 규칙: 가격, 예약, 포인트 정책을 표와 항목으로 구조화했습니다.
   3. 버그: SiteService의 치명적인 기간 검색 오류와 데이터 불일치 문제를 명시했습니다.
   4. 코드 이슈: God Class 문제, 동시성 이슈, 중복 코드, 하드코딩 문제 등을 상세히 기록했습니다.
```


```
todo.md에서 “2.리스크 매트릭스 작성”을 참고해 수행한 후 risk-matrix.md에 기록해주세요. risk-matrix.md에 기재된 양식을 참고해주세요.
```


```text
✦ 리스크 매트릭스 작성을 완료했습니다.
   1. 평가 수행: 주요 기능 8개를 선정하여 비즈니스 임팩트, 변경 빈도, 버그 가능성 기준으로 점수를 매겼습니다.
   2. 결과 기록: risk-matrix.md 파일에 평가표와 Top 3 선정 근거(예약 생성, 기간별 가용 사이트 검색, 예약 취소)를 상세히 기록했습니다. 특히 '기간별 가용 사이트 검색' 기능에서 발견된
      치명적인 버그가 높은 리스크 점수에 반영되었습니다.
   3. 상태 업데이트: todo.md의 해당 항목을 완료 처리했습니다.
```


```text
todo.md에 “3. 인수 조건 도출”을 참고해 수행한 결과를 acceptance-criteria.md에 기록해주세요. 처음보는 사람도 이해하기 쉽게 기록해주세요.
```


```
todo.md에 “4. Gherkin 시나리오 작성”을 참고해 수행한 결과를 scenarios.feature에 기록해주세요.
scenarios.feature에 기재된 양식을 지켜주세요.
초보자도 알기 쉽게 구분지어서 기록해주세요.
```


```
✦ Gherkin 시나리오 작성을 완료했습니다.

   1. 시나리오 작성: scenarios.feature 파일에 리스크가 높은 3가지 기능(예약 생성, 검색, 취소)에 대한 시나리오를 작성했습니다.
   2. 구성: 각 기능(Feature)별로 정상 케이스(Scenario)와 비즈니스 규칙에 따른 예외 케이스를 포함했습니다.
       * 특히 '기간별 검색' 기능에서는 중간 날짜가 예약된 경우 검색에서 제외되는지 검증하는 시나리오를 명시했습니다.
   3. 가독성: 초보자도 이해하기 쉽도록 주석으로 기능 설명과 시나리오 의도를 덧붙였습니다.
   4. 상태 업데이트: todo.md의 마지막 항목을 완료 처리했습니다.
```


> 궁금) 시나리오를 읽을때도 When, Then, Given 순으로 읽어야 하는가


---

`260114`
- http 파일로 직접 호출 테스트를 함
	- 예약을 취소한 상태에서 다시 생성할 경우 이미 예약이 있다고 함
		- `status : CANCELLED`
		- soft delete 상태라서 재예약이 불가능하다.
	- 사이트 목록에 반환되는 데이터와 상세 조회 내용이 동일하다. 
		- 개인적으로 노출되면 안되는 내용같은건 없어 보인다 
	- `GET http://localhost:8080/api/sites/search?startDate=2026-02-01&endDate=2026-01-30`
		- 사이트 기간별 검색시 시작일과 종료일이 안 맞으면 500 error를 출력한다.
			- 500보다는 사용자 입력이 잘못된거 아닌가?
			- 예외가 전부다 `RuntimeException` 하드코딩


참고. https://github.com/next-step/atdd-camping-reservation/pull/56/files/732417a30bcfcb448f47789ccfeccabe0a787fe4

```
핵심 비즈니스 규칙 

예약 규칙 
- 예약 가능 시간 
- 고객 정보 검증 : 내용 없음
- 중복 예약 방지 : 내용 없음 
- 예약 식별 인증 : confirmationCode(확인 코드) 기재 되어 있지만 어떤 형태인지 설명 없음
- 예약 취소 정책 : CANCELLED_SAME_DAY에 대한 언급만 있고 CANCELLED 상태에 대한 언급이 없다.
```

```
잠재적 버그 및 코드 스멜 

심각한 동시성 문제 (위치, 문제점, 위험성)
- ReservationService.createReservation 인데 **포인트 적립 로직 불일치**에 심각도는 minor라고 되어만 있음
  

비효율적인 데이터 조회
- `ReservationService.getMonthlyCalendar()`, `getReservationsByDate()`, `getDailyReservationCount()` 등 다수
- 전체 데이터 조회후 메모리 필터링 

거대하고 복잡한 메서드 (Goe Method)

광범위한 코드 중복 

일반적인 예외 처리

하드 코딩된 값

```


```text
# 시스템 분석 결과

## 1. API 엔드포인트 분석 (총 12개)

### 1.1 예약 도메인 (Reservation) - `/api/reservations`
| Method | Endpoint | 설명 | 주요 파라미터 |
|--------|----------|------|--------------|
| POST | `/` | 예약 생성 | `ReservationRequest` (이름, 기간, 사이트번호, 폰번호 등) |
| GET | `/{id}` | 예약 단건 조회 | `id` (Path) |
| GET | `/` | 예약 목록 조회 | `date` (Optional), `customerName` (Optional) |
| DELETE | `/{id}` | 예약 취소 | `id` (Path), `confirmationCode` (Query) |
| PUT | `/{id}` | 예약 수정 | `id` (Path), `confirmationCode` (Query), Body |
| GET | `/my` | 내 예약 조회 | `name`, `phone` |
| GET | `/calendar` | 월별 예약 캘린더 | `year`, `month`, `siteId` |

### 1.2 사이트 도메인 (Site) - `/api/sites`
| Method | Endpoint | 설명 | 주요 파라미터 |
|--------|----------|------|--------------|
| GET | `/` | 전체 사이트 목록 | 없음 |
| GET | `/{siteId}` | 사이트 상세 조회 | `siteId` (DB PK) |
| GET | `/{siteNumber}/availability` | 특정 사이트 가용성 확인 | `siteNumber` (String ID), `date` |
| GET | `/available` | 날짜별 가용 사이트 조회 | `date` |
| GET | `/search` | 기간별 가용 사이트 검색 | `startDate`, `endDate`, `size` |

---

## 2. 숨겨진 비즈니스 규칙

### 가격 정책 (Pricing)
| 구분 | 내용 | 비고 |
|------|------|------|
| **기본 요금** | A구역(대형): 80,000원<br>B구역(소형): 50,000원<br>기타: 60,000원 | 1박 기준 |
| **주말 할증** | 기본 요금의 **30%** 가산 | 토요일, 일요일 |
| **성수기 할증** | 기본 요금의 **50%** 가산 | 7월, 8월 |
| **복합 할증** | 성수기 주말: 기본 요금의 **70%** 가산 | 성수기 + 주말 |

### 예약 규칙 (Reservation Rules)
| 구분 | 규칙 내용 | 비고 |
|------|-----------|------|
| **예약 가능 기간** | 신청일(오늘)로부터 최대 **30일** 이내의 날짜까지만 예약 가능 | 과거 날짜 예약 불가 |
| **고객 정보 검증** | - 이름: **2자 이상** 20자 이하<br>- 전화번호: 숫자만 포함하여 **10~11자리** 필수<br>- 사이트 번호: 필수 입력 | 이름 공백 불가 |
| **중복 예약 방지** | 동일 사이트에 대해 **요청 기간(시작일~종료일)이 기존 예약과 단 하루라도 겹칠 경우** 예약 불가 | 동시성 제어 미비로 버그 위험 있음 |
| **예약 식별 인증** | 예약 완료 시 **6자리의 영문 대문자와 숫자 조합**으로 구성된 `confirmationCode` 자동 생성 및 발급 | 예약 조회/수정/취소 시 필수 |
| **예약 취소 정책** | - **일반 취소**: 예약 시작일 이전 취소 시 상태 `CANCELLED`<br>- **당일 취소**: 예약 시작일 당일 취소 시 상태 `CANCELLED_SAME_DAY` | 환불 규정은 코드에 명시되지 않음 |

### 포인트 정책 (Point) - *비일관성 주의*
- **기본**: 결제 금액의 5% 적립.
- **주말**: 주말 포함 시 10% 적립 (일부 로직).
- **결제 수단별**: 카드(10%), 모바일(8%), 계좌이체(5%), 현금(3%) (Deprecated 메서드 기준).

---

## 3. 버그 목록 (Bugs)

| 번호 | 위치 | 설명 | 심각도 |
|------|------|------|--------|
| 1 | `SiteService.searchAvailableSites` | **기간 검색 로직 오류**: 시작일(`startDate`)과 종료일(`endDate`)의 가용성만 체크하고, 그 사이의 날짜(중간 기간)가 예약되어 있는지 확인하지 않음. 이로 인해 이미 예약된 날짜를 포함하여 중복 예약이 가능해짐. | **Critical** |
| 2 | `Data` vs `Logic` 불일치 | **전기 사용 여부**: DB(`data.sql`)상 B구역 설명에는 "전기 있음"으로 되어 있으나, 코드(`SiteService`)에서는 사이트 번호가 'A'로 시작할 때만 전기가 있는 것으로 처리함. | Major |
| 3 | `ReservationService.createReservation` | **포인트 적립 로직 불일치**: `calculatePoints` 메서드에는 성수기 3% 적립 로직이 있으나, 실제 예약 생성 시에는 반영되지 않음. | Minor |

---

## 4. 코드 이슈 (Code Issues)

### 구조 및 설계 (Architecture)
- **God Class (`ReservationService`)**: 예약 생성, 조회, 취소뿐만 아니라 가격 계산, 포인트 계산, 알림 로깅, 통계 등 너무 많은 책임을 가지고 있음.
- **Layer Violation**: 컨트롤러에서 `ResponseEntity` 내에 `Map`을 직접 생성하여 에러를 반환하는 패턴이 반복됨. Global Exception Handler 도입 필요.

### 동시성 (Concurrency)
- **Race Condition**: `createReservation`에서 `existsBy...`로 중복 확인 후 `save`하는 사이에 락(Lock)이 걸려있지 않음. 동시에 여러 요청이 들어오면 중복 예약이 발생할 수 있음 (코드 내 `Thread.sleep`으로 취약점 시뮬레이션 중).

### 품질 (Quality)
- **Duplicated Code**: 날짜 유효성 검증, 전화번호 검증 등의 로직이 여러 메서드(`create`, `update`, `search`)에 중복되어 있음.
- **Hardcoded Values**: 가격(80000, 50000...), 할증률(1.7, 1.5...), 포인트 적립률 등이 코드 내에 하드코딩되어 있어 유지보수가 어려움.
- **Deprecated Usage**: `ReservationController` 내에 Deprecated된 `CalendarService` 필드가 존재하며, 코드 정리가 필요함.

```

> 재수정 후 커밋 


### 리스크 매트릭스

```text
# 리스크 매트릭스

## 평가 기준
- **척도**: 높음(3점), 보통(2점), 낮음(1점)
- **계산식**: 리스크 점수 = 비즈니스 임팩트 + 변경 빈도 + 버그 가능성

## 평가 결과
| 기능 | 비즈니스 임팩트 | 변경 빈도 | 버그 가능성 | 총점 | 순위 |
|-----|:---:|:---:|:---:|:---:|:---:|
| **예약 생성** | 높음(3) | 높음(3) | 높음(3) | **9** | **1** |
| **기간별 가용 사이트 검색** | 높음(3) | 보통(2) | 높음(3) | **8** | **2** |
| **예약 취소** | 높음(3) | 보통(2) | 보통(2) | **7** | **3** |
| 예약 수정 | 보통(2) | 보통(2) | 보통(2) | 6 | 4 |
| 특정 사이트 가용성 확인 | 보통(2) | 낮음(1) | 높음(3) | 6 | 4 |
| 예약 목록 조회 | 보통(2) | 낮음(1) | 낮음(1) | 4 | 6 |
| 사이트 상세 조회 | 낮음(1) | 낮음(1) | 낮음(1) | 3 | 7 |
| 전체 사이트 목록 조회 | 낮음(1) | 낮음(1) | 낮음(1) | 3 | 7 |

## Top 3 선정 근거

### 1. 예약 생성 (9점)
- **비즈니스 임팩트(3)**: 캠핑장의 핵심 매출원이자 가장 중요한 기능입니다. 예약 실패는 즉각적인 고객 불만과 매출 손실로 이어집니다.
- **변경 빈도(3)**: 가격 정책, 포인트 적립, 할인 이벤트 등 비즈니스 로직이 가장 빈번하게 변경되는 영역입니다.
- **버그 가능성(3)**: 동시성 이슈(Race Condition), 복잡한 검증 로직(날짜, 가격, 중복 체크), 외부 결제 연동(시뮬레이션) 등이 얽혀 있어 버그 발생 가능성이 매우 높습니다.

### 2. 기간별 가용 사이트 검색 (8점)
- **비즈니스 임팩트(3)**: 고객이 예약을 하기 위한 첫 번째 관문입니다. 잘못된 검색 결과(이미 예약된 사이트가 가능한 것으로 표시)는 중복 예약 시도로 이어져 치명적인 사용자 경험을 초래합니다.
- **변경 빈도(2)**: 검색 필터(전기 유무, 사이트 크기 등) 추가나 정렬 기준 변경이 발생할 수 있습니다.
- **버그 가능성(3)**: 현재 시스템 분석 결과, **시작일과 종료일 사이의 중간 날짜 예약 여부를 체크하지 않는 치명적인 버그**가 확인되었습니다. 또한 날짜 계산 로직은 항상 오류 가능성이 높습니다.

### 3. 예약 취소 (7점)
- **비즈니스 임팩트(3)**: 환불 정책과 직결되어 금전적 문제가 발생할 수 있으며, 취소된 사이트가 즉시 재판매 가능한 상태로 전환되어야 매출 기회 손실을 막을 수 있습니다.
- **변경 빈도(2)**: 환불 규정(위약금, 취소 가능 기한)의 변경이 있을 수 있습니다.
- **버그 가능성(2)**: 본인 인증(확인 코드), 상태 변경(`CANCELLED` vs `CANCELLED_SAME_DAY`), 환불 금액 계산 등에서 실수가 발생할 수 있습니다.

```

추가 질문
```text
아래 내용을 참고해 risk-matrix.md를 수정해주세요
1. 평가 기준을 세 단계(척도 정의, 평가 항목, 계산식 등)로 나눠 처음 읽는 사람도 이해하기 쉽게 설명해주세요. 표나 항목 중에 선택해서 작성해주세요

2. 평가 결과를 나타낼때 예약과 사이트를 나눠서 작성해주세요. 

3. 평가 결과를 통합해서 전체 순위를 표로 나타내 주세요
   
4. TOP3 선정 근거를 설명할때 관련 코드 스멜이 어디에 있는지 클래스와 줄 번호 정보도 있으면 좋겠습니다.

그리고 목차를 상단에 추가해주세요
```


```text
✦ risk-matrix.md 파일을 요청하신 가이드라인에 맞춰 전면 수정했습니다.

   1. 목차 추가: 문서 상단에 목차를 배치하여 탐색을 용이하게 했습니다.
   2. 평가 기준 상세화: 3단계 척도(높음/보통/낮음) 정의와 평가 항목, 계산식을 명확히 기술했습니다.
   3. 도메인별 분리: 평가 결과를 '예약 도메인'과 '사이트 도메인'으로 나누어 표기했습니다.
   4. 통합 순위표: 두 도메인의 결과를 합쳐 리스크 점수 순으로 정렬한 전체 통합 표를 제공했습니다.
   5. Top 3 근거 및 코드 정보: 선정 근거뿐만 아니라 ReservationService.java와 SiteService.java의 구체적인 메서드 위치(줄 번호)와 코드 스멜(동시성 이슈, 로직 버그, God Method 등)을
      상세히 명시했습니다.
```


추가 질문
```text
risk-matrix.md에서 총 API가 12개인데 누락된게 있는거 같습니다. 평가결과에서 "등급(점수)"형태(ex. "높음(3)")로 표기해주세요(총점은 그대로). 전체 통합 순위에 비고 말고 우선순위
  표기하는게 더 낫지 않을까요? 열을 하나 더 추가해 테스트 난이도 평가 정보도 있으면 어떨까요?
```

---

### 인수 조건 도출 

```text
아래 TODO 내용과 수정된 risk-matrix.md를 참고해 인수 조건 도출 문서의 내용을 수정해주세요 (acceptance-criteria.md). 5W1H는 표로 정리하는게 깔끔할거 같습니다. 

3. 인수 조건 도출
   - 우선순위를 높게 평가한 기능에 대해 5W1H 분석을 수행하세요
   - 각 기능의 핵심 인수 조건을 한 문장으로 정의하세요
   - 검증해야 할 핵심 포인트들을 나열하세요
```

before
```text
# 인수 조건 도출

이 문서는 리스크 매트릭스에서 우선순위가 높게 평가된 핵심 기능들에 대한 인수 조건을 정의합니다.

---

## 1. 예약 생성 (Reservation Creation)

### 5W1H 분석
- **Who**: 캠핑장 이용 고객
- **When**: 캠핑장 방문 전 (오늘 기준 30일 이내)
- **Where**: 예약 시스템 (API/Web)
- **What**: 캠핑 사이트 예약 및 확정
- **Why**: 원하는 날짜에 사이트를 선점하고 이용 권한을 얻기 위해
- **How**: 이름, 연락처, 사이트 번호, 기간 정보를 입력하여 예약 요청

### 핵심 인수 조건
> "고객은 원하는 사이트와 기간을 선택하여 예약을 신청할 수 있으며, 시스템은 유효성 검사 및 중복 체크를 거쳐 예약 확인 코드를 발급해야 한다."

### 핵심 검증 포인트
- [ ] 오늘로부터 30일 이내의 날짜만 예약 가능한가?
- [ ] 과거 날짜나 종료일이 시작일보다 빠른 설정이 차단되는가?
- [ ] 필수 정보(이름 2자 이상, 전화번호 10~11자리 숫자)가 모두 입력되었는가?
- [ ] 동일한 사이트와 기간에 대해 중복 예약이 발생하지 않는가? (동시성 제어)
- [ ] 예약 성공 시 6자리의 영숫자 확인 코드가 생성되는가?
- [ ] 사이트 타입(A/B) 및 기간(주말/성수기)에 따른 가격이 정확히 계산되는가?

---

## 2. 기간별 가용 사이트 검색 (Period Availability Search)

### 5W1H 분석
- **Who**: 예약을 원하는 잠재 고객
- **When**: 예약 전, 일정에 맞는 빈 자리를 탐색할 때
- **Where**: 캠핑 사이트 검색 페이지
- **What**: 입력한 기간 동안 전체 일정이 비어 있는 사이트 목록
- **Why**: 자신의 여행 일정에 맞춰 예약 가능한 사이트를 한눈에 파악하기 위해
- **How**: 시작일과 종료일, (선택사항) 사이트 크기를 입력하여 검색

### 핵심 인수 조건
> "사용자가 입력한 시작일부터 종료일까지의 **모든 날짜**에 대해 예약이 없는 사이트들만 필터링하여 정확하게 목록을 제공해야 한다."

### 핵심 검증 포인트
- [ ] 시작일과 종료일 사이의 **중간 날짜**에 예약이 있는 사이트가 검색 결과에서 제외되는가? (현재 발견된 버그 수정 확인)
- [ ] 과거 날짜로 검색하는 것이 차단되는가?
- [ ] 사이트 크기(대형/소형) 필터가 정확하게 작동하는가?
- [ ] 검색 결과에 사이트의 상세 정보(전기 가능 여부, 최대 인원 등)가 올바르게 표시되는가?

---

## 3. 예약 취소 (Reservation Cancellation)

### 5W1H 분석
- **Who(누가)**: 예약을 완료한 고객
- **When(언제)**: 개인 사정으로 인해 방문이 어려워졌을 때
- **Where(어디서)**: 내 예약 정보 확인 페이지
- **What(무엇을)**: 기존 예약의 철회 및 상태 업데이트
- **Why(왜)**: 이용하지 않을 예약을 취소하고, 다른 고객이 이용할 수 있도록 사이트를 개방하기 위해
- **How(어떻게)**: 예약 ID와 발급받은 확인 코드를 입력하여 취소 요청

### 핵심 인수 조건
> "고객은 예약 시 발급받은 확인 코드를 통해 본인 인증을 완료한 후 예약을 취소할 수 있으며, 시스템은 취소 시점에 따라 예약 상태를 업데이트해야 한다."

### 핵심 검증 포인트
- [ ] 입력한 확인 코드가 예약 시 발급된 코드와 일치할 때만 취소가 승인되는가?
- [ ] 존재하지 않는 예약 ID나 잘못된 확인 코드에 대해 적절한 에러 메시지를 반환하는가?
- [ ] 당일 취소 시 상태가 `CANCELLED_SAME_DAY`로, 사전 취소 시 `CANCELLED`로 정확히 구분되는가?
- [ ] 취소 완료 즉시 해당 사이트와 기간이 다시 예약 가능한 상태(검색 결과에 노출)로 전환되는가?

```


```text
✦ acceptance-criteria.md 문서를 요청하신 사항에 맞춰 수정했습니다.

   1. 5W1H 분석 표기 변경: 줄글 형식 대신 표(Table)를 사용하여 가독성을 높이고 정보를 깔끔하게 정리했습니다.
   2. 검증 포인트 구체화: 각 검증 항목 앞에 키워드(예: 기간 제한, 중간 날짜 체크 등)를 추가하여 어떤 측면을 검증하는지 명확히 했습니다.
   3. 내용 보완: risk-matrix.md의 분석 내용을 반영하여 동시성 제어, 중간 날짜 버그 수정 확인, 재고 복구 등 핵심적인 검증 사항을 강화했습니다.
```

---

### Gherkin

before
```text
# 캠핑장 예약 시스템 상세 Gherkin 시나리오

# -------------------------------------------------------------------
# Feature 1: 예약 생성 (Reservation Creation)
# -------------------------------------------------------------------
Feature: 예약 생성
  고객으로서, 원하는 날짜와 사이트를 예약하여 캠핑장 이용 권한을 확보하고 싶다.

  Background:
    Given 오늘은 "2026-01-14" 수요일이다
    And "A-1"은 대형 사이트이며 최대 6명 수용 가능하다

  Scenario: 유효한 정보로 예약 생성 (비성수기 평일)
    When 고객이 다음과 같은 정보로 예약을 요청한다:
      | 항목 | 값 |
      | 고객명 | "홍길동" |
      | 전화번호 | "01012345678" |
      | 사이트번호 | "A-1" |
      | 시작일 | "2026-02-10" |
      | 종료일 | "2026-02-11" |
      | 인원수 | 4 |
    Then 응답 코드는 201(Created)이어야 한다
    And 예약 상세 정보에 다음이 포함되어야 한다:
      | 항목 | 기대값 |
      | status | "CONFIRMED" |
      | customerName | "홍길동" |
      | phoneNumber | "01012345678" |
    And 6자리의 영문 대문자와 숫자로 구성된 "confirmationCode"가 발급되어야 한다

  Scenario: 예약 기간 제한 위반 (30일 초과)
    When 고객이 "2026-02-01"부터 "2026-03-10"까지 (37박) 예약을 요청한다
    Then 응답 코드는 409(Conflict) 또는 400이어야 한다
    And 에러 메시지에 "예약 기간은 최대 30일입니다"가 포함되어야 한다

  Scenario: 고객 이름 유효성 검사 실패 (너무 짧음)
    When 고객이 이름을 "김"으로 입력하여 예약을 요청한다
    Then 응답 코드는 400(Bad Request) 또는 409이어야 한다
    And 에러 메시지에 "예약자 이름은 최소 2자 이상이어야 합니다"가 포함되어야 한다

  Scenario: 가격 계산 검증 (성수기 주말 할증)
    # 성수기(7,8월) + 주말(토,일) = 70% 할증 적용 확인
    Given "A-1" 사이트의 기본 요금은 80,000원이다
    When 고객이 성수기 주말인 "2026-07-11"(토)부터 "2026-07-12"(일)까지 1박 예약을 요청한다
    Then 시스템 내부 로직에서 계산된 총 금액은 136,000원이어야 한다
    # 계산식: 80,000 * 1.7 = 136,000

# -------------------------------------------------------------------
# Feature 2: 기간별 가용 사이트 검색 (Availability Search)
# -------------------------------------------------------------------
Feature: 가용 사이트 검색
  예약 희망자로서, 내 여행 일정 동안 비어 있는 사이트 목록을 정확히 확인하고 싶다.

  Scenario: 연박 가능 여부의 정확한 검증 (중간 날짜 체크)
    Given 다음과 같은 예약 현황이 존재한다:
      | 사이트 | 예약 시작일 | 예약 종료일 | 상태 |
      | "A-1" | "2026-02-15" | "2026-02-15" | "CONFIRMED" |
      | "A-2" | "2026-02-10" | "2026-02-13" | "CONFIRMED" |
    When 사용자가 "2026-02-14"부터 "2026-02-16"까지 (2박 3일) 예약 가능한 사이트를 검색한다
    Then 검색 결과에 "A-1" 사이트가 포함되지 않아야 한다
    And 검색 결과에 "A-2" 사이트는 포함되어야 한다
    # 이유: A-1은 중간 날짜인 15일이 이미 예약됨, A-2는 14~16일 사이가 모두 비어 있음

  Scenario: 사이트 크기 및 전기 사양 필터링 검색
    Given "A-1"은 "대형"이고 전기가 가능하다
    And "B-1"은 "소형"이고 전기가 불가능하다 (로직 기준)
    When 사용자가 "대형" 사이즈 필터를 적용하여 검색한다
    Then 결과 목록의 모든 사이트는 "size"가 "대형"이어야 한다
    And 결과 목록에 "A-1"은 포함되고 "B-1"은 제외되어야 한다

# -------------------------------------------------------------------
# Feature 3: 예약 취소 (Reservation Cancellation)
# -------------------------------------------------------------------
Feature: 예약 취소 및 본인 확인
  예약자로서, 확인 코드를 통해 내 예약을 안전하게 취소하고 싶다.

  Scenario: 확인 코드 불일치로 인한 취소 거부
    Given ID가 50번이고 확인 코드가 "SAFE12"인 예약이 존재한다
    When 사용자가 ID 50번과 잘못된 코드 "HACK00"으로 취소를 요청한다
    Then 응답 코드는 400(Bad Request)이어야 한다
    And 에러 메시지에 "확인 코드가 일치하지 않습니다"가 포함되어야 한다
    And 해당 예약의 상태는 여전히 "CONFIRMED"여야 한다

  Scenario: 당일 취소와 사전 취소의 상태 구분
    Given 오늘은 "2026-01-14"이다
    And 시작일이 "2026-01-14"인 예약 A와 "2026-01-15"인 예약 B가 있다
    When 사용자가 예약 A를 취소한다
    Then 예약 A의 상태는 "CANCELLED_SAME_DAY"가 된다
    When 사용자가 예약 B를 취소한다
    Then 예약 B의 상태는 "CANCELLED"가 된다

  Scenario: 취소 후 즉시 재예약 가능 확인
    Given "A-1" 사이트가 "2026-02-01"에 예약되어 있다
    When 해당 예약을 올바른 코드로 취소 완료한다
    Then "2026-02-01" 날짜로 "A-1" 사이트를 검색했을 때 "available"이 true여야 한다
    And 동일한 조건으로 다시 예약 생성이 성공해야 한다
```


```
✦ scenarios.feature 파일을 검토 후 요청하신 대로 보완했습니다.

  주요 보완 사항:
   1. Feature 1 (예약 생성):
       * 경계값 테스트 추가: 30일(최대 기간)을 꽉 채워 예약하는 정상 케이스를 추가하여 비즈니스 규칙 검증을 강화했습니다.
       * 동시성 제어 시나리오 구체화: "사용자 A와 B가 거의 동시에 요청"하는 상황을 명시하고, 결과(하나 성공, 하나 실패, 데이터 1건 유지)를 명확히 했습니다.

   2. Feature 2 (가용 사이트 검색):
       * 일반 정상 케이스 추가: 예약이 없는 평범한 기간에 검색 시 목록이 잘 나오는지 확인하는 시나리오를 추가했습니다. (기존에는 버그 재현용 시나리오만 있었음)
       * 상세 정보 검증 추가: 검색 결과에 maxPeople, hasElectricity 등의 정보가 포함되는지 확인하는 단계를 추가했습니다.

   3. 표현 개선:
       * 각 Feature 상단에 비즈니스 목표를 주석으로 명시하여 이해를 도왔습니다.
       * "Status 200" 등의 기술적 용어와 함께 "예약이 성공적으로 생성되어야 한다"와 같은 비즈니스 관점의 문장을 병기했습니다.

  이제 인수 조건과 시나리오가 촘촘하게 연결되었으며, 테스트 커버리지가 한층 높아졌습니다.
```

after
```text
# 캠핑장 예약 시스템 상세 Gherkin 시나리오

# -------------------------------------------------------------------
# Feature 1: 예약 생성 (Reservation Creation)
# 비즈니스 목표: 고객은 30일 이내의 기간 동안 원하는 사이트를 선점하여 이용 권한을 확보해야 한다.
# -------------------------------------------------------------------
Feature: 예약 생성
  고객으로서, 나는 캠핑을 즐기기 위해 원하는 사이트와 날짜를 선택하여 예약을 확정받고 싶다.

  Background:
    Given 기준 날짜는 "2026-01-14" (수요일)이다
    And "A-1"은 대형 사이트이며 최대 6명 수용 가능하다

  # [정상 케이스] 일반적인 예약 성공
  Scenario: 유효한 정보로 예약 요청 시 예약이 확정되어야 한다
    When 고객이 "홍길동", "01012345678" 정보로 "A-1" 사이트에 대해 "2026-02-10"부터 "2026-02-11"까지(1박) 예약을 요청한다
    Then 예약이 성공적으로 생성되어야 한다 (Status 201)
    And 예약 상태는 "CONFIRMED"여야 한다
    And 6자리의 "confirmationCode"가 발급되어야 한다

  # [정상 케이스] 경계값 테스트 (최대 기간)
  Scenario: 최대 예약 가능 기간(30박)을 꽉 채워 예약 요청
    When 고객이 "2026-01-15"부터 "2026-02-14"까지 정확히 30박 예약을 요청한다
    Then 예약이 성공적으로 생성되어야 한다 (Status 201)

  # [예외 케이스] 비즈니스 규칙 위반 (기간 초과)
  Scenario: 예약 제한 기간(30박)을 초과하여 요청
    When 고객이 "2026-01-15"부터 "2026-02-15"까지 (31박) 예약을 요청한다
    Then 예약이 거부되어야 한다 (Status 400 or 409)
    And "예약 기간은 최대 30일입니다"라는 에러 메시지가 반환되어야 한다

  # [예외 케이스] 입력값 유효성 검증 실패
  Scenario: 유효하지 않은 고객 이름(너무 짧음) 입력
    When 고객이 이름을 "김"으로 입력하여 예약을 요청한다
    Then 예약이 거부되어야 한다 (Status 400)
    And "예약자 이름은 최소 2자 이상이어야 합니다"라는 에러 메시지가 반환되어야 한다

  Scenario: 유효하지 않은 전화번호(형식 오류) 입력
    When 고객이 전화번호를 "010-123-456" (9자리)으로 입력하여 예약을 요청한다
    Then 예약이 거부되어야 한다 (Status 400)
    And "전화번호 형식이 올바르지 않습니다"라는 에러 메시지가 반환되어야 한다

  # [예외 케이스] 동시성 이슈 (Critical)
  Scenario: 동일한 사이트와 기간에 대해 중복 예약 시도 (동시성 제어)
    Given "A-1" 사이트의 "2026-02-20" 날짜는 현재 예약이 없다
    When 사용자 A와 사용자 B가 거의 동시에 "2026-02-20" 날짜로 "A-1" 예약을 요청한다
    Then 시스템은 두 요청 중 하나만 승인(201)해야 한다
    And 나머지 하나는 거부(409 Conflict)하고 "이미 예약된 기간입니다"라고 알려야 한다
    And 최종적으로 "A-1" 사이트의 "2026-02-20" 예약 데이터는 1건만 존재해야 한다

  # [정상 케이스] 가격 정책 검증
  Scenario: 성수기 주말 할증 요금 자동 계산
    # 조건: 기본 80,000원, 성수기(7~8월) 1.5배, 주말 1.3배 -> 복합 시 1.7배
    Given "A-1" 사이트의 기본 1박 요금은 80,000원이다
    When 고객이 성수기 주말인 "2026-07-11"(토)부터 "2026-07-12"(일)까지 예약을 요청한다
    Then 시스템이 계산한 총 결제 예정 금액은 136,000원이어야 한다

# -------------------------------------------------------------------
# Feature 2: 기간별 가용 사이트 검색 (Availability Search)
# 비즈니스 목표: 고객은 자신의 일정에 맞는 빈 사이트를 정확히 찾을 수 있어야 한다.
# -------------------------------------------------------------------
Feature: 가용 사이트 검색
  예약 희망자로서, 일일이 눌러보지 않고 내 일정에 예약 가능한 사이트 목록만 보고 싶다.

  # [정상 케이스] 기본 검색
  Scenario: 예약이 없는 기간으로 검색 시 가능한 사이트 목록 반환
    Given "A-1"과 "B-1" 사이트는 "2026-03-01"부터 "2026-03-03" 기간 동안 예약이 없다
    When 사용자가 "2026-03-01"부터 "2026-03-03"까지 검색한다
    Then 검색 결과 목록에 "A-1"과 "B-1"이 모두 포함되어야 한다
    And 각 사이트 정보에 "available: true"가 표시되어야 한다

  # [예외 케이스] 로직 버그 검증 (중간 날짜 점유)
  Scenario: 기간 내 중간 날짜가 예약된 사이트는 검색에서 제외 (연박 불가)
    Given "A-1" 사이트는 "2026-02-15" 하루가 이미 예약되어 있다
    And "A-2" 사이트는 해당 기간에 예약이 전혀 없다
    When 사용자가 "2026-02-14"부터 "2026-02-16"까지 (2박 3일) 검색한다
    Then 검색 결과에 "A-1" 사이트는 포함되지 않아야 한다 (중간 날짜 예약됨)
    And 검색 결과에 "A-2" 사이트는 포함되어야 한다

  # [예외 케이스] 날짜 유효성 검증
  Scenario: 과거 날짜 포함 검색 차단
    Given 기준 날짜는 "2026-01-14"이다
    When 사용자가 어제인 "2026-01-13"부터 "2026-01-15"까지 검색한다
    Then 검색 요청이 거부되어야 한다 (Status 400)
    And "과거 날짜는 검색할 수 없습니다"라는 에러 메시지가 반환되어야 한다

  # [정상 케이스] 필터링 및 정보 표시
  Scenario: 사이트 크기 필터링 및 상세 정보 확인
    Given "A-1"은 "대형" 사이트이고 전기가 가능하다
    And "B-1"은 "소형" 사이트이다
    When 사용자가 "대형" 사이즈로 필터링하여 검색한다
    Then 결과 목록에는 "A-1"만 포함되어야 한다
    And 결과 데이터에는 사이트의 "최대 인원(maxPeople)"과 "전기 가능 여부(hasElectricity)"가 포함되어야 한다

# -------------------------------------------------------------------
# Feature 3: 예약 취소 (Reservation Cancellation)
# 비즈니스 목표: 고객은 본인 인증을 통해 예약을 취소하고, 시스템은 즉시 재고를 확보해야 한다.
# -------------------------------------------------------------------
Feature: 예약 취소
  예약자로서, 사정이 생겼을 때 내 예약을 안전하게 취소하고 싶다.

  Background:
    Given ID가 100번이고 확인 코드가 "SAFE12"인 예약이 존재한다

  # [정상 케이스] 취소 성공 및 재고 복구
  Scenario: 올바른 확인 코드로 취소 시 재고가 즉시 복구됨
    Given "A-1" 사이트가 해당 예약(ID 100)으로 점유되어 있다
    When 사용자가 ID 100번과 코드 "SAFE12"로 취소를 요청한다
    Then 취소가 성공적으로 처리되어야 한다 (Status 200)
    And 예약 상태가 "CANCELLED"로 변경되어야 한다
    And 해당 날짜에 "A-1" 사이트를 다시 검색하면 결과에 노출되어야 한다 (재예약 가능)

  # [예외 케이스] 본인 인증 실패
  Scenario: 확인 코드가 일치하지 않으면 취소 불가
    When 사용자가 ID 100번과 틀린 코드 "WRONG0"으로 취소를 요청한다
    Then 취소 요청이 거부되어야 한다 (Status 400)
    And "확인 코드가 일치하지 않습니다"라는 에러 메시지가 반환되어야 한다
    And 예약 상태는 여전히 "CONFIRMED"여야 한다

  # [정상 케이스] 취소 정책 (상태 구분)
  Scenario: 당일 취소 시 별도 상태 코드로 관리
    Given ID가 200번이고 시작일이 "오늘(2026-01-14)"인 예약이 있다
    When 사용자가 ID 200번 예약을 취소한다
    Then 예약 상태는 "CANCELLED_SAME_DAY"가 되어야 한다
    # 비고: 당일 취소는 환불 규정이 다를 수 있으므로 상태를 구분함
```

---


> 동시성 제어 (예약)을 시나리오 테스트에서 하는 것 맞지 않는 것 같다. 
> 시나리오는 시나리오에 집중해야지 비즈니스 로직 문제를 건드리는 건 다른 단위/통합 테스트에서 해야 하는게 맞는 듯 하다

> 날짜 제어도 그렇고 블랙 박스 형태로 바야 한다면 .. 시나리오 테스트에서 고려할 대상이 아니라고 생각

