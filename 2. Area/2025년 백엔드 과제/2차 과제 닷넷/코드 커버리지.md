

**테스트 커버리지 측정** 
- `C# .NET`은 프로페셔널부터 기본적으로 지원을 해준다

`coverlet-coverage`
- [coverlet-coverage/coverlet: Cross platform code coverage for .NET](https://github.com/coverlet-coverage/coverlet)
	- 📌[coverlet/Documentation/VSTestIntegration.md at master · coverlet-coverage/coverlet](https://github.com/coverlet-coverage/coverlet/blob/master/Documentation/VSTestIntegration.md)
	- exclude filter 처리 통해 dtos 제거하고 측정 

### xUnit 템플릿 프로젝트 생성 (디렉터리 구조)

💩 `디렉터리 구조 문제`
- 기존에 C# .NET 프로젝트 안에 Tests 만들어서 테스트를 돌렸는데 .. 이렇게 할 경우 coverlet-coverage가 동작하지 않는다 
- 기본적으로 C# .NET 진영에서는 `대상 프로젝트`와 같은 위치에 `테스트 프로젝트`를 따로 만들어서 관리
- 테스트 관련 내용은 테스트용 프로젝트로 옮겨버리고 `csproj`에 reference를 추가하여 실제 프로젝트를 참조한다함
- 이렇게 분리함으로써 실제 프로젝트 빌드시 테스트 관련 패키지를 분리할 수 있다함 
	- `build.gradle`에서 그루비 스크립트로 작성을 했었는데 (사스가 수동 데스네)


과제 프로젝트보다 한 단계 위에 루트에서
```shell
// 1. xUnit 템플릿 프로젝트 생성
dotnet new xunit -n ShipParticularsApi.Tests

// 2. 새로만든 테스트 프로젝트에 기존 앱 프로젝트 참조 추가
dotnet add ShipParticularsApi.Tests reference ShipParticularsApi

// 3. 코드 이동
// ShipParticulars에 있던 Tests 폴더 코드를 ShipParticularsApi.Tests로 이동
// 이때 나는 Tests 폴더 자체를 옮겼는데, 그러다보니 namespace가 한 depth 더 길어짐
```
- `.sln` 파일이 있는 최상위 디렉터리는 프로젝트 구조의 기준점이 됨


<img src="./images/코드커버리지1.png">
- `CoverageReport`는  reportgenerator 도구 통해 생성된다 
- `TestResults`는 coverlet 도구 통해 테스트 실행하면서 xml 파일을 만든다 
	- 옵션을 주면 여러 확장자를 만들어 주나 보다

```text
visual studio 확장자로 coverlet.collector 검색해서 설치
```

> ✅ 디렉터리를 복사 붙여넣기 하면 namespace 변경과 using 패키지가 누락되는 이슈가 있어서 직접 다 수정해야 했음


### CLI로 도구 설치

```shell
// 코드 커버리지 측정
dotnet tool install -g coverlet.console

// 레포트 제네레이터
dotnet tool install -g dotnet-reportgenerator-globaltool

dotnet build

coverlet --version
```


### 필터링 
- Dtos, Exceptions와 같은 불필요한 내용이 커버리지에 포함되면 퍼센트가 낮아짐
- 💩 CLI 명령어에 필터 옵션 추가하려고 했으나 문법 에러가 계속 발생해 처리 못함 
	- powershell이다 보니 .. 특수문자나 그런 처리를 인식하지 못하는 것으로 생각

`repo/ShipParticulars/coverlet.runsettings`
```text
<?xml version="1.0" encoding="utf-8"?>
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat Code Coverage">
        <Configuration>
          <ExcludeByFile>**/Dtos/**/*.cs,**/Exceptions/**/*.cs,**/Migrations/*.cs</ExcludeByFile>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
```

### 테스트 실행 및 커버리지 xml 생성

테스트 실행시에는 `ShipParticulars.Tests` 들어가서 실행해야 하다보니 상대경로 설정파일을 호출하게 된다
```shell
dotnet test .\ShipParticularsApi.Tests.csproj --collect:"XPlat Code Coverage" /p:CoverletOutputFormat=cobertura /p:CoverletOutput=./TestResults/coverage.cobertura.xml --settings ..\coverlet.runsettings
```

✅ output 경로와 명칭을 설정해놔야지 나중에 sonarcloud에 맥일 수 있다.(옵션 알아보기)

### 레포트 생성
```shell
reportgenerator -reports:"{coverlet 결과로 생성된 xml경로}" -targetdir:"coverageresults" -reporttypes:Html
```

<img src="./images/코드커버리지 결과.png">


### 기타 

ShipParticulars.Tests에서 아래 swagger 패키지 삭제 
```text
<PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
```

```shell
dotnet restore
```
- `dotnet test` 실행시 통합 테스트가 Development로 실행되고 있어 Program.cs에 분기문에 Swagger 호출하다보니 컴파일 에러 발생💩
- `appsettings.Test.json`을 ShipParticulars 프로젝트에 추가
- `CustomWebApplicationFactory.cs` // ShipParticulars.Tests
	- `builder.UseEnvironment("Test");` // Test 환경변수 사용하도록 수정


### Reference.
[coverlet/Documentation/VSTestIntegration.md at master · coverlet-coverage/coverlet](https://github.com/coverlet-coverage/coverlet/blob/master/Documentation/VSTestIntegration.md)



---

**TODO**
- 프로젝트에 패키지 정리 (ok)
	- `ShipParticulars` 
	- `ShipParticulars.Tests`
- README.md 작성
- remote 저장소 반영 
	- 개인꺼만 우선 반영..



