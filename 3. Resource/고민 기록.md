
### íŠ¸ëœì­ì…˜ ê´€ë ¨
- ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œ ì½”ë“œ ì˜ˆì‹œ

>[!warning] Call transactional methods via an injected dependency instead of directly via 'this'.

í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì—¬ëŸ¬ ë©”ì„œë“œë¥¼ ì§ì ‘ í˜¸ì¶œí•  ê²½ìš°, íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ ì•„ë‹Œ thisë¡œ í˜¸ì¶œí•˜ê²Œ ë˜ëŠ” í”„ë¡ì‹œ í•œê³„ì— ëŒ€í•œ ì†Œë‚˜ê·œì¹™ì´ì—ˆë‹¤

```java
@Service  
@RequiredArgsConstructor  
public class CouponIssueService {  
  
    private final CouponJpaRepository couponJpaRepository;  
    private final CouponIssueJpaRepository couponIssueJpaRepository;  
    private final CouponIssueRepository couponIssueRepository;  
    private final ApplicationEventPublisher applicationEventPublisher;  
  
    @Transactional  
    public void issueWithLock(long couponId, long userId) {  
        Coupon coupon = findCouponWithLock(couponId); // ğŸ’©
        coupon.issue();  
        saveCouponIssue(couponId, userId); // ğŸ’©
        publishCouponEvent(coupon);  
    }

	// ..

}
```


ê¸°ëŠ¥ ìƒì— ë¬¸ì œê°€ ì—†ì—ˆì§€ë§Œ, êµ³ì´ ìê¸°ìì‹  (`CouponIssueService`) ì£¼ì…ë°›ì•„ í˜¸ì¶œí•˜ê±°ë‚˜, CQRSë¥¼ ì ìš©í•˜ëŠ”ê²Œ ì½”ë“œ ë³µì¡ë„ë§Œ ì˜¬ë¼ê°€ê³  í¬ê²Œ ì„±ëŠ¥ê°œì„ í•  ê²ƒ ê¹Œì§€ëŠ” ì—†ë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.

Chat-GPTì—ê²Œ ë‚´ ìƒê°ì„ ë§í–ˆê³ , ì•„ë˜ì™€ ê°™ì´ ë‹µë³€ì„ í–ˆë‹¤ 
```text
ë§ìŠµë‹ˆë‹¤! ì†Œë‚˜íë¸Œ ê·œì¹™ì— ëŒ€í•œ ê²½ê³ ëŠ” **ë¬¼ë¦¬ì ì¸ íŠ¸ëœì­ì…˜**ì„ í•˜ë‚˜ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒë³´ë‹¤ëŠ” **ë…¼ë¦¬ì ìœ¼ë¡œ ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬**í•˜ëŠ” ê²ƒì´ ì´ì ì´ ìˆì„ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ, **íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•œë‹¤ê³  í•´ì„œ ë°˜ë“œì‹œ ì„±ëŠ¥ì´ ê°œì„ ë˜ê±°ë‚˜ ì½”ë“œ í’ˆì§ˆì´ ì¢‹ì•„ì§€ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤**. ë³µì¡ì„±ë§Œ ì¦ê°€í•˜ê³  ì‹¤ì œë¡œ **ë¬¸ì œê°€ ë˜ì§€ ì•ŠëŠ” ìƒí™©ì—ì„œëŠ” êµ³ì´ ë¶„ë¦¬í•  í•„ìš”ê°€ ì—†ë‹¤**ëŠ” ì ì„ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•  ë•Œì˜ ì£¼ìš” **ì´ì **ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. **ë‹¨ì¼ ì±…ì„ ì›ì¹™(SRP, Single Responsibility Principle)**ì„ ì¶©ì¡±ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°ê°ì˜ ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì±…ì„ì„ ë§¡ê²Œ ë˜ì–´ í…ŒìŠ¤íŠ¸ì™€ ìœ ì§€ë³´ìˆ˜ì—ì„œ ìœ ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. íŠ¸ëœì­ì…˜ì˜ **ì „íŒŒ**ê°€ ëª…í™•í•˜ê²Œ ì ìš©ë˜ì–´, ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ë¡¤ë°± ë²”ìœ„ê°€ ë¶„ë¦¬ë˜ì–´ ì•ˆì •ì ì¸ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. ë¶„ë¦¬ëœ íŠ¸ëœì­ì…˜ì€ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ë¡¤ë°±í•˜ê±°ë‚˜ ì»¤ë°‹í•  ìˆ˜ ìˆì–´ **ì—ëŸ¬ ì²˜ë¦¬**ë¥¼ ì¢€ ë” ì„¸ë°€í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ **íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•˜ë©´ ë³µì¡ë„ ì¦ê°€**ì™€ **ì¶”ê°€ì ì¸ ê´€ë¦¬ ì˜¤ë²„í—¤ë“œ**ê°€ ìˆì„ ìˆ˜ ìˆê³ , **ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì‹¤ì œë¡œ íŠ¸ëœì­ì…˜ì„ í•˜ë‚˜ë¡œ ë¬¶ì–´ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë” ê°„ë‹¨í•˜ê³  ì§ê´€ì ì¸ ê²½ìš°ë„ ë§ìŠµë‹ˆë‹¤.

### **ê²°ë¡ **

- **íŠ¸ëœì­ì…˜ ë¶„ë¦¬ì˜ ì¥ì **ì€ ì—¬ëŸ¬ ê°œì˜ ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ì„ í†µí•´ **ì—ëŸ¬ ì²˜ë¦¬**ë‚˜ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ë…ë¦½ì„±**ì„ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆì§€ë§Œ, **ë³µì¡ì„±**ì´ ì¶”ê°€ëœë‹¤ëŠ” ë‹¨ì ë„ ìˆìŠµë‹ˆë‹¤.
- í˜„ì¬ **ë¬¸ì œê°€ ë˜ì§€ ì•ŠëŠ” ìƒí™©**ì—ì„œëŠ” êµ³ì´ íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•  í•„ìš”ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë©°, **ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ê´€ë¦¬**í•˜ëŠ” ë°©ì‹ë„ ì¶©ë¶„íˆ ì¢‹ìŠµë‹ˆë‹¤.
- íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•˜ëŠ” ê²ƒê³¼ ê´€ë ¨ëœ **ì†Œë‚˜íë¸Œ ê²½ê³ **ë¥¼ ì‹ ê²½ ì“¸ ë•ŒëŠ”, ê·¸ ê²½ê³ ê°€ ì‹¤ì œë¡œ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë¬¸ì œ**ì¸ì§€, ì•„ë‹ˆë©´ ë‹¨ìˆœíˆ ì½”ë“œ ìŠ¤íƒ€ì¼ì— ëŒ€í•œ ë¬¸ì œì¸ì§€ë„ ê³ ë ¤í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.
```

ì°¸ê³ . 
- [íŠ¸ëœì­ì…˜ ë‚´ë¶€ í˜¸ì¶œ ì§ˆë¬¸ ê´€ë ¨í•˜ì—¬ ì§ˆë¬¸ìˆìŠµë‹ˆë‹¤.](https://www.inflearn.com/community/questions/1467042/%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EB%82%B4%EB%B6%80-%ED%98%B8%EC%B6%9C-%EC%A7%88%EB%AC%B8-%EA%B4%80%EB%A0%A8%ED%95%98%EC%97%AC-%EC%A7%88%EB%AC%B8%EC%9E%88%EC%8A%B5%EB%8B%88%EB%8B%A4)
- [ë‚´ë¶€ í˜¸ì¶œì— ëŒ€í•œ ì¬ì§ˆë¬¸](https://www.inflearn.com/community/questions/1224196/%EB%82%B4%EB%B6%80-%ED%98%B8%EC%B6%9C%EC%97%90-%EB%8C%80%ED%95%9C-%EC%9E%AC%EC%A7%88%EB%AC%B8)
- [ìš°ì•„í•œ í˜•ì œ](https://techblog.woowahan.com/2606/)
- [ê¸°ìˆ  ë¸”ë¡œê·¸-ìŠ¤í”„ë§ @Transactional](https://cs-ssupport.tistory.com/503)
- [ê¸°ìˆ  ë¸”ë¡œê·¸ - íŠ¸ëœì­ì…˜ì€ ì–¸ì œ ì–´ë–»ê²Œ ë¡¤ë°± ë ê¹Œ?(1,2í¸)] (https://dkswnkk.tistory.com/760)
- [@Transactional ì—†ì• ë ¤ë‹¤ ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ê¹Œì§€ ë§Œë“  ì´ì•¼ê¸°](https://blog.ban-life.com/transactional-%EC%97%86%EC%95%A0%EB%A0%A4%EB%8B%A4-%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC%EA%B9%8C%EC%A7%80-%EB%A7%8C%EB%93%A0-%EC%9D%B4%EC%95%BC%EA%B8%B0-5426116036bb)
- [ë§ë‚˜ë‹ˆ ê°œë°œì ë¸”ë¡œê·¸](https://mangkyu.tistory.com/154)
- [@Transactional (readOnly=true)ì™€ ì—†ëŠ” ê²ƒì˜ ì°¨ì´](https://velog.io/@wony_k/Transactional-read-only)
- [ê¸°ìˆ ë¸”ë¡œê·¸ - í…ŒìŠ¤íŠ¸ ë‚´ìš©ìˆì–´ì„œ ê´œì°®ì€ë“¯](https://junhyunny.github.io/spring-boot/jpa/junit/transactional-readonly/)
- í† ë¹„ë‹˜ê³¼ ê¹€ì˜í•œë‹˜ ê°•ì˜ ì°¸ê³ í•´ì„œ íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ì°¾ì•„ë³´ì


---
### jacoco, sonar 
- ë©€í‹° ëª¨ë“ˆ í”„ë¡œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ì„œë¸Œ ëª¨ë“ˆì— ê°œë³„ jacocoReportê°€ ìƒì„±ë˜ì–´ í™•ì¸ë„ ë”°ë¡œ í•˜ê²Œ ë¨
- `jacoco-report-aggregation` í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš©í•´ì„œ í•œ êµ°ë°ì— ëª¨ì•˜ìœ¼ë‚˜ sonarcloudì—ì„œ **xml**ì„ ì¸ì‹í•˜ì§€ ëª»í•˜ëŠ” ëª¨ìŠµì„ ë³´ì¸ë‹¤

**í•´ê²°**
- `code-coverage-report` ì„œë¸Œ ëª¨ë“ˆ ë§Œë“¤ì–´ì„œ jacoco reportë¥¼ í†µí•©í•˜ëŠ” ê²ƒì€ ë§ì•˜ë‹¤ 
- `jar.enabled = true` í•´ì•¼ í•¨
```gradle
plugins {  
    id 'jacoco-report-aggregation'  
}  
  
repositories {  
    mavenCentral()  
}  
  
dependencies {  
    jacocoAggregation(project(":coupon-core"))  
    jacocoAggregation(project(":coupon-api"))  
    jacocoAggregation(project(":coupon-consumer"))  
}  
  
jar {  
    enabled = true  
}
```

**ê²½ë¡œ ì´ìŠˆ í•´ê²°**
ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì˜ build.gradleì—ì„œ `*.xmlReportPaths` ê²½ë¡œ ì„¤ì •ì´ ì˜ëª»ë˜ì–´ì„œ ì¸ì‹ë˜ì§€ ëª»í–ˆì—ˆë‹¤
ê·¸ë˜ì„œ `${rootProject.projectDir}` ì¶”ê°€í•˜ì—¬ sonar ì‹¤í–‰ì‹œ ì˜¬ë°”ë¥´ê²Œ ì¸ì‹í•˜ë„ë¡ í•˜ì˜€ë‹¤
```gradle
sonar {  
    properties {  
        property("sonar.organization", "leejinwoo1126")  
        property("sonar.host.url", "https://sonarcloud.io")  
        property("sonar.projectKey", "ljw1126_coupon-issue")  
        property("sonar.projectName", "coupon-issue")  
        property("sonar.sources", "src/main/java")  
        property("sonar.tests", "src/test/java")  
        property("sonar.coverage.jacoco.xmlReportPaths", "${rootProject.projectDir}/code-coverage-report/build/reports/jacoco/testCodeCoverageReport/testCodeCoverageReport.xml")  
        property("sonar.junit.reportPaths", "build/test-results/test")  
    }  
}  
  
tasks.register("codeCoverageReport") {  
    dependsOn ":code-coverage-report:testCodeCoverageReport"  
    doLast {  
        println "Code coverage report executed from code-coverage-report module."  
    }  
}
```


```shell
$ SONAR_TOKEN={} ./gradlew clean codeCoverageReport sonar
```
- codeCoverageReport ì‹¤í–‰ì‹œ ëª¨ë“ˆë³„ë¡œ test , jacocoReport, í†µí•©ì´ ì´ë¤„ì§„ë‹¤
- ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ `code-coverage-report` ëª¨ë“ˆì˜ gradle ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” í˜•íƒœ
- ê·¸ë˜ì„œ sonar ì‹¤í–‰ì‹œ ì´ì „ ë²„ì „ê³¼ ë¹„êµí•œ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ì¸¡ì •ë˜ì–´ sonarcloudì—ì„œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤


**ë²„ì „ ì´ìŠˆ í•´ê²°**
ì•„ë˜ì™€ ê°™ì´ ë²„ì „ì„ ë§ì¶œ ê²½ìš° sonar ì‹¤í–‰ì‹œ gradleì— depreactedëœ ë©”ì„œë“œë¡œ ì¸í•´ ì‹¤í–‰ì´ ë˜ì§€ ì•Šì•˜ë‹¤ (ì•„ë˜ sonar problem report)

```
- The org.gradle.api.plugins.Convention type has been deprecated.`:sonar` 
- The org.gradle.api.plugins.JavaPluginConvention type has been deprecated.`:sonar`
```

- java 21
- gradle 8.13 
- org.sonarqube (LTS, 6.x)
- jacoco 0.8.11 


`*.xmlReportPaths` ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆë˜ê±°ì˜€ê¸°ì— ì´ì „ì— ì‹¤í–‰ë˜ë˜ ë²„ì „ìœ¼ë¡œ ì›ë³µí•˜ë‹ˆ ì •ìƒ ì‹¤í–‰ë˜ì—ˆë‹¤.
- java 17
- gradle 8.10
- org.sonarqube 5.0.0.4638
- jacoco 0.8.8


>[!warning] SonarCloudì— í•´ë‹¹ í”„ë¡œì íŠ¸ ìë™ ë¶„ì„ ì„¤ì •ì´ ì¼œì ¸ ìˆëŠ” ê²½ìš° ì¶©ëŒ ë°œìƒ ê°€ëŠ¥
>- ì¸í…”ë¦¬ì œì´ì—ì„œ SonarCloud ì—°ë™í•œ ê²½ìš° ìë™ ë¶„ì„ì´ ì§„í–‰ë˜ëŠ” ê±¸ë¡œ ìƒê°ë¨
>- ê·¸ë˜ì„œ sonar ì‹¤í–‰ì‹œ ì¶©ëŒ ë°œìƒ
>- ì´ ê²½ìš° SonarCloudì˜ í”„ë¡œì íŠ¸ ìë™ ë¶„ì„ ì„¤ì •ì„ off í•œë‹¤


**ì½”ë“œ ì»¤ë²„ë¦¬ì§€ íŒ¨í‚¤ì§€ ì œì™¸**
- dto, configuration, exception íŒ¨í‚¤ì§€ê°€ í¬í•¨ë˜ì„œ ì „ì²´ ì»¤ë²„ë¦¬ì§€ê°€ ë‚®ì•„ì§
- ì°¸ê³ . 
	- [ìŠ¤íƒ ì˜¤ë²„ í”Œë¡œìš°](https://stackoverflow.com/questions/77321859/how-to-exclude-files-from-jacoco-report-with-gradle)
	- [Baeldung](https://www.baeldung.com/jacoco-report-exclude)


**ì°¸ê³ .** 
[ìš°ì•„í•œ í˜•ì œ](https://techblog.woowahan.com/2661/)
[ê¸°ìˆ  ë¸”ë¡œê·¸](https://haril.dev/blog/2022/07/29/jacoco-aggregation-report)
[Gradle - Compatibility Notes](https://docs.gradle.org/8.10/userguide/compatibility.html)
[jacoco Releases info](https://github.com/jacoco/jacoco/releases)
[gradle - org.sonarqube](https://plugins.gradle.org/plugin/org.sonarqube/5.0.0.4638)
[sonarqube doce](https://docs.sonarsource.com/sonarqube-server/latest/analyzing-source-code/scanners/sonarscanner-for-gradle/)

---